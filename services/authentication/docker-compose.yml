services:
  authentication-service:
    build:
      context: .
      target: web
    container_name: authentication-service
    environment:
      SECRET_KEY: ${SECRET_KEY:-insecure-key}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,authentication-service,host.docker.internal}
      DATABASE_NAME: ${DATABASE_NAME:-authentication}
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-postgres}
      DATABASE_HOST: ${DATABASE_HOST:-authentication-database}
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000,http://gateway-service:4001}
      CORS_ALLOW_ALL_ORIGINS: ${CORS_ALLOW_ALL_ORIGINS:-False}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-True}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-accept,accept-encoding,authorization,content-type,dnt,origin,user-agent,x-csrftoken,x-requested-with,x-tenant-id}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: ${ENVIRONMENT:-dev}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-authentication-service}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      OTEL_EXPORTER_OTLP_PROTOCOL: ${OTEL_EXPORTER_OTLP_PROTOCOL:-grpc}
      OTEL_TRACES_EXPORTER: ${OTEL_TRACES_EXPORTER:-otlp}
      OTEL_METRICS_EXPORTER: ${OTEL_METRICS_EXPORTER:-otlp}
      OTEL_LOGS_EXPORTER: ${OTEL_LOGS_EXPORTER:-otlp}
      OTEL_METRIC_EXPORT_INTERVAL: ${OTEL_METRIC_EXPORT_INTERVAL:-5000}
      OTEL_BSP_SCHEDULE_DELAY: ${OTEL_BSP_SCHEDULE_DELAY:-5000}
      PORT: ${PORT:-8000}
      KEYS_DIR: ${KEYS_DIR:-/keys}
      KEY_PASSWORD: ${KEY_PASSWORD:-insecure-password}
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8000/health || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - "8000:8000"
    depends_on:
      authentication-migrations:
        condition: service_completed_successfully
      authentication-keygen:
        condition: service_completed_successfully
      authentication-database:
        condition: service_healthy
    volumes:
      - jwt_keys:/keys
    networks:
      - aviation-network

  authentication-database:
    image: postgres:17.6
    container_name: authentication-database
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-authentication}
      POSTGRES_USER: ${DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-authentication}" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - aviation-network

  authentication-migrations:
    build:
      context: .
      target: migrate
    container_name: authentication-migrations
    depends_on:
      authentication-keygen:
        condition: service_completed_successfully
      authentication-database:
        condition: service_healthy
    environment:
      SECRET_KEY: ${SECRET_KEY:-insecure-key}
      KEYS_DIR: ${KEYS_DIR:-/keys}
      KEY_PASSWORD: ${KEY_PASSWORD:-insecure-password}
      DATABASE_NAME: ${DATABASE_NAME:-authentication}
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-postgres}
      DATABASE_HOST: ${DATABASE_HOST:-authentication-database}
      DATABASE_PORT: ${DATABASE_PORT:-5432}
    volumes:
      - jwt_keys:/keys
    restart: "no"
    networks:
      - aviation-network

  authentication-keygen:
    build:
      context: ./keys
    container_name: authentication-keygen
    volumes:
      - jwt_keys:/keys
    environment:
      KEYS_DIR: /keys
      KEY_PASSWORD: ${KEY_PASSWORD:-insecure-password}
    command: python generate_keys.py
    restart: "no"
    networks:
      - aviation-network

volumes:
  jwt_keys:

networks:
  aviation-network:
    name: aviation-network
    driver: bridge